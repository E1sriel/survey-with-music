<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>问卷测试与音乐播放</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" href="data:,">
    <style>
        /* 统一播放控件样式 */
        #mobile-controls {
            display: none;
            margin-top: 10px;
            gap: 10px;
        }
        @media (max-width: 768px) {
            #mobile-controls { display: flex; }
            #native-controls { display: none; }
        }
    </style>
</head>
<body>
    <div class="questionnaire-container">
        <iframe src="https://www.wjx.cn/vm/PpX1K07.aspx" 
                frameborder="0" 
                style="width:100%;height:80vh">
        </iframe>
    </div>

    <div id="music-player">
        <div id="song-title">当前播放：请选择音乐</div>
        <select id="music-selector">
            <option value="">-- 选择背景音乐 --</option>
            <option value="CMJ - 所念皆星河.mp3">所念皆星河</option>
            <option value="AniFace - 夜、萤火虫和你.mp3">夜、萤火虫和你</option>
            <option value="羽肿 - 花火が瞬く夜に.mp3">花火が瞬く夜に</option>
            <option value="凤凰院零零 - Tyndall effect (丁达尔效应).mp3">丁达尔效应</option>
        </select>
        
        <!-- 平台自适应控件 -->
        <div id="mobile-controls">
            <button id="play-btn">▶️ 播放</button>
            <button id="pause-btn">⏸️ 暂停</button>
        </div>
        <audio id="native-controls" controls></audio>
    </div>

    <script>
        // 跨平台音频控制器
        const audioController = (() => {
            const audio = new Audio();
            let isUserInteracted = false;
            
            // 初始化音频设置
            audio.controls = false;
            audio.loop = true;
            
            // 用户交互检测
            document.addEventListener('click', () => {
                isUserInteracted = true;
            }, { once: true });

            return {
                load: function(url) {
                    audio.pause();
                    audio.src = url;
                },
                play: function() {
                    if (isUserInteracted) {
                        return audio.play().catch(e => {
                            console.log('播放需要用户交互');
                        });
                    }
                    return Promise.reject();
                },
                pause: function() {
                    audio.pause();
                },
                get element() {
                    return audio;
                }
            };
        })();

        // 设备检测
        const isMobile = /Mobi|Android/i.test(navigator.userAgent);
        
        // 初始化界面
        document.getElementById('native-controls').replaceWith(audioController.element);
        
        // 音乐加载逻辑
        document.getElementById('music-selector').addEventListener('change', e => {
            if (!e.target.value) return;
            
            const filename = encodeURIComponent(e.target.value);
            audioController.load(`assets/music/${filename}`);
            document.getElementById('song-title').textContent = 
                `当前播放：${e.target.value.split(' - ')[1].replace('.mp3', '')}`;
            
            // 桌面端自动播放(仅在用户已交互时)
            if (!isMobile) {
                audioController.play();
            }
        });

        // 移动端控制绑定
        document.getElementById('play-btn').addEventListener('click', () => {
            audioController.play().then(() => {
                audioController.element.dispatchEvent(new Event('play'));
            });
        });
        
        document.getElementById('pause-btn').addEventListener('click', () => {
            audioController.pause();
        });

        // 统一播放状态同步
        audioController.element.addEventListener('play', () => {
            document.getElementById('mobile-controls').style.display = 'flex';
        });
    </script>
</body>
</html>
