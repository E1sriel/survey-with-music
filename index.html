<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <!-- 移动端视口关键设置 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>问卷测试与音乐播放</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" href="data:,">
    <!-- 移动端专用样式 -->
    <style>
        /* 手机端iframe高度适配 */
        @media (max-width: 768px) {
            .questionnaire-container iframe {
                height: calc(100vh - 160px) !important;
            }
            
            #music-player {
                bottom: 10px;
                right: 10px;
                left: 10px;
                width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="questionnaire-container">
        <iframe src="https://www.wjx.cn/vm/PpX1K07.aspx" 
                frameborder="0" 
                style="width:100%;height:80vh">
        </iframe>
    </div>

    <div id="music-player">
        <div id="song-title">当前播放：请选择音乐</div>
        <select id="music-selector">
            <option value="">-- 选择背景音乐 --</option>
            <option value="CMJ - 所念皆星河.mp3">所念皆星河</option>
            <option value="AniFace - 夜、萤火虫和你.mp3">夜、萤火虫和你</option>
            <option value="羽肿 - 花火が瞬く夜に.mp3">花火が瞬く夜に</option>
            <option value="凤凰院零零 - Tyndall effect (丁达尔效应).mp3">丁达尔效应</option>
        </select>
        <audio id="audio-player" controls></audio>
        <div id="mobile-tips" style="display:none;color:#ff4444;font-size:12px;margin-top:8px;">
            点击播放按钮即可开始音乐
        </div>
    </div>

    <script>
        // 移动端兼容处理
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent);
        const audioPlayer = document.getElementById('audio-player');
        const musicSelector = document.getElementById('music-selector');
        const baseMusicPath = 'assets/music/';

        // 安全加载音乐文件
        const loadMusic = (filename) => {
            if (!filename) return;

            // 处理中文路径
            const safeFilename = encodeURIComponent(filename).replace(/%25/g, '%');
            const musicURL = baseMusicPath + safeFilename;

            // 创建新的Audio对象
            const newAudio = new Audio(musicURL);
            newAudio.loop = true;

            // 移动端播放策略
            if (isMobile) {
                document.getElementById('mobile-tips').style.display = 'block';
                audioPlayer.style.display = 'none'; // 隐藏原生控件
            }

            newAudio.addEventListener('loadeddata', () => {
                audioPlayer.src = musicURL;
                updateSongTitle(filename);
                
                // 桌面端自动播放
                if (!isMobile) {
                    newAudio.play().catch(e => console.log('桌面端自动播放被阻止'));
                }
            });

            newAudio.addEventListener('error', () => {
                console.error('加载失败:', musicURL);
                document.getElementById('song-title').textContent = '音乐加载失败';
            });
        };

        // 更新显示名称（兼容移动端）
        const updateSongTitle = (filename) => {
            const cleanName = filename
                .replace(/\.mp3$/, '')
                .split(' - ')[1] || filename;
            document.getElementById('song-title').textContent = `当前播放：${cleanName}`;
        };

        // 事件监听
        musicSelector.addEventListener('change', (e) => {
            loadMusic(e.target.value);
        });

        // 移动端播放交互
        document.getElementById('music-player').addEventListener('click', (e) => {
            if (isMobile && e.target === audioPlayer) {
                audioPlayer.play().catch(() => {
                    document.getElementById('mobile-tips').style.display = 'block';
                });
            }
        });

        // 初始化加载
        loadMusic(musicSelector.options[1].value);
    </script>
</body>
</html>
