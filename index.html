<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>问卷测试与音乐播放</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- 阻止favicon请求 -->
    <link rel="icon" href="data:,">
</head>
<body>
    <!-- 问卷容器 -->
    <div class="questionnaire-container">
        <iframe src="https://www.wjx.cn/vm/PpX1K07.aspx" 
                frameborder="0" 
                style="width:100%;height:80vh">
        </iframe>
    </div>

    <!-- 音乐播放器 -->
    <div id="music-player">
        <div id="song-title">当前播放：请选择音乐</div>
        <select id="music-selector">
            <option value="">-- 选择背景音乐 --</option>
            <option value="CMJ - 所念皆星河.mp3">所念皆星河</option>
            <option value="AniFace - 夜、萤火虫和你.mp3">夜、萤火虫和你</option>
            <option value="羽肿 - 花火が瞬く夜に.mp3">花火が瞬く夜に</option>
            <option value="凤凰院零零 - Tyndall effect (丁达尔效应).mp3">丁达尔效应</option>
        </select>
        <audio id="audio-player" controls></audio>
    </div>

    <script>
        // 严格模式确保代码质量
        'use strict';

        // 初始化核心组件
        const audioPlayer = document.getElementById('audio-player');
        const musicSelector = document.getElementById('music-selector');
        const baseMusicPath = 'assets/music/';

        // 音乐加载器
        const musicLoader = {
            currentAudio: null,
            
            load: function(filename) {
                if (!filename) return this.clear();

                const fullPath = baseMusicPath + encodeURIComponent(filename);
                const newAudio = new Audio(fullPath);
                
                // 卸载旧音频
                if (this.currentAudio) {
                    this.currentAudio.pause();
                    this.currentAudio.removeEventListener('loadedmetadata', this.handleMetadata);
                }

                // 配置新音频
                newAudio.loop = true;
                newAudio.addEventListener('loadedmetadata', this.handleMetadata.bind(this, filename));
                newAudio.addEventListener('error', this.handleError);
                
                this.currentAudio = newAudio;
                audioPlayer.src = fullPath;
            },

            handleMetafunction(filename) {
                const displayName = filename
                    .replace(/\.mp3$/, '')
                    .replace(/(.+?)\s*-\s*(.+)/, '$2');
                document.getElementById('song-title').textContent = `当前播放：${displayName}`;
                this.currentAudio.play().catch(() => {
                    console.log('需要用户交互后才能自动播放');
                });
            },

            handleError: function() {
                document.getElementById('song-title').textContent = '音乐加载失败';
                console.error('文件路径错误:', this.currentAudio.src);
            },

            clear: function() {
                audioPlayer.removeAttribute('src');
                document.getElementById('song-title').textContent = '当前播放：未选择音乐';
            }
        };

        // 事件绑定
        musicSelector.addEventListener('change', (e) => {
            musicLoader.load(e.target.value);
        });

        // 初始化默认音乐
        musicSelector.value = musicSelector.options[1].value;
        musicLoader.load(musicSelector.value);
    </script>
</body>
</html>
